<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7">
<meta name="author" content="Andrew Block &lt;ablock@redhat.com&gt;, Ishu Verma &lt;iverma@redhat.com&gt;">
<title>Serverless for IoT lab</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<h1>Serverless for IoT lab</h1>
<div class="details">
<span id="author" class="author">Andrew Block &lt;ablock@redhat.com&gt;, Ishu Verma &lt;iverma@redhat.com&gt;</span><br>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_lab_contents">Lab Contents</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
TODO: Insert Links to each Lab
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_technology_overview" class="sect0">Technology Overview</h1>
<div class="sect1">
<h2 id="_serverless">Serverless</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Serverless refers to the concept of building and running applications that do not require server management. Serverless allows for a finer-grained deployment model where applications, bundled as one or more functions, are uploaded to a platform and then executed, scaled, and billed in response to the exact demand needed at that moment. Developers using serverless no longer need to spend time and resources on server provisioning, maintenance, updates, scaling, and capacity planning.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Servers are still required to run a serverless platform. The provider will need to manage servers (or virtual machines or containers) and deploy the serverless platform for an external or internal customers.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serverless_use_cases">Serverless use cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Serverless approach is a good choice when the workload is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Asynchronous, concurrent, easy to parallelize into independent units of work</p>
</li>
<li>
<p>Infrequent or has sporadic demand, with large, unpredictable variance in scaling requirements</p>
</li>
<li>
<p>Stateless, ephemeral, without a major need for instantaneous cold start time</p>
</li>
<li>
<p>Highly dynamic in terms of changing business requirements that drive a need for accelerated developer velocity</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_function_as_a_service_faas">Function as a Service (FaaS)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FaaS is a type of serverless computing that typically provides event-driven computing. Developers run and manage application code with functions that are triggered by events. Developers deploy small units of code to the FaaS, which are executed as needed as discrete actions, scaling without the need to manage servers or any other underlying infrastructure.</p>
</div>
<div class="paragraph">
<p>Popularized by AWS Lambda, there are several other FaaS offerings in the market Azure Functions, IBM Cloud Functions, Google Cloud Functions etc.</p>
</div>
<div class="paragraph">
<p>Apache OpenWhisk is a serverless, open source cloud platform that executes functions in response to events. OpenWhisk can be deployed on public cloud, premises or a combination of both (hybrid).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_serverless_for_iot">Using serverless for IoT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Internet of Things (IoT) is expected to generate a massive and diverse range of data types presenting a unique challenges for back end services.  The back end services must be able to quickly respond and scale in response to sudden influx of messages. Serverless functions can efficiently manage and filter messages from IoT devices. They can both scale elastically and shield other services downstream from the load. Some of the examples of using serverless for IoT include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Executing logic in response to device data values</p>
</li>
<li>
<p>Performing analytics on IoT sensor messages</p>
</li>
<li>
<p>Handling stream processing</p>
</li>
<li>
<p>Serving machine learning and AI models</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_your_own_serverless_solution">Deploying your own serverless solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab, an IoT solution will be built with Red Hat OpenShift Container Platform and serverless architecture to execute on-demand functions in response to IoT events. Main components of the lab include setting up Apache OpenWhisk, building functions and deploying these functions to OpenWhisk.</p>
</div>
<div class="paragraph">
<p>Reference:
<a href="https://github.com/cncf/wg-serverless/tree/master/whitepaper">https://github.com/cncf/wg-serverless/tree/master/whitepaper</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_to_use_case">Introduction to Use Case</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_iot_overview">IoT Overview</h3>
<div class="paragraph">
<p>IDC defines Internet of Things (IoT) as a network of uniquely identifiable end points (or ‘things’) that communicate bi-directionally without human interaction using IP connectivity. For consumers, this could mean ability to control the thermostat, doors, irrigation system from across the world but for businesses, IoT can create new opportunities to connect with customers and partners and achieve operational efficiencies. IoT has potential to transform entire industries from transportation, retail, oil &amp; gas, utilities to stadiums.</p>
</div>
<div class="paragraph">
<p>Vast numbers of endpoints (smart sensors, GPS devices, transponders, handheld devices), will generate massive volume of data. Once data from millions of devices is collected, it needs to be acted on immediately or transformed, summarized and stored to be acted on later.</p>
</div>
</div>
<div class="sect2">
<h3 id="_iot_use_case">IoT Use Case</h3>
<div class="paragraph">
<p>This lab demonstrates how Serverless can be used for IoT use cases that require analytics of IoT device messages. In the use case for this lab, a factory wants to closely monitor critical assets through their lifecycle to improve operational efficiencies.  Each equipment is assigned to a specific area (geofence) in the factory. Equipments advertise their location coordinates (sent over mqtt protocol). This location data is transformed, enhanced and stored in a database for persistent storage using various functions. If an equipment moves outside its geofence, an alert is triggered using another function.</p>
</div>
<div class="paragraph">
<p>Equipment location is visualized on a geographical map using Google map API. Google Geolocation API is used to show each equipment’s geofence. Map data is dynamically updated with different markers used to indicate if an equipment is within its geofence or not.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/lab-workflow.png" alt="Lab Workflow">
</div>
</div>
</div>
</div>
</div>
<h1 id="_lab_environment" class="sect0">Lab Environment</h1>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
TODO: Need to provide introductory information about lab environment
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OpenShift environment for this lab consists of the following systems:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Hostname</th>
<th class="tableblock halign-left valign-top">Internal IP</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bastion.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bastion host</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>master.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Master</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>node01.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.11</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node 01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>node02.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node 02</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>node03.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.13</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node 03</p></td>
</tr>
</tbody>
</table>
<div class="sect1">
<h2 id="_get_guid">Get GUID</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Open a web browser and navigate to: <a href="https://www.opentlc.com/guidgrabber/guidgrabber.cgi">https://www.opentlc.com/guidgrabber/guidgrabber.cgi</a></p>
</div>
<div class="paragraph">
<p>Select and fill in the following values:</p>
</div>
<div class="paragraph">
<p>Lab code: <strong>L1122 - Develop IoT solutions with containers and serverless patterns</strong><br>
Activation key: <strong>iot</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/guid-grabber.png" alt="Request GUID">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_lab_environment">Access Lab environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interaction with the environment will be facilitated using several mechanisms listed below:</p>
</div>
<div class="sect2">
<h3 id="_ssh">SSH</h3>
<div class="paragraph">
<p>The primary method is using SSH to a workstation (bastion) host.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ssh lab-user@workstation-&lt;GUID&gt;.rhpds.opentlc.com</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openshift_cli">OpenShift CLI</h3>
<div class="paragraph">
<p>OpenShift features a Command Line Interface for interacting with the Platform. The executable has been already installed and is available from the bastion host.</p>
</div>
<div class="paragraph">
<p>Login to OpenShift with the following credentials</p>
</div>
<div class="paragraph">
<p>User: <strong>admin</strong><br>
Password: <strong>r3dh4t1!</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">oc login infranode-&lt;GUID&gt;.generic.opentlc.com:8443 +</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see a warning related to insecure certificates. Given that this is a lab environment, it is OK to safely ignore these warnings. Type <strong>Y</strong> and hit Enter.</p>
</div>
<div class="paragraph">
<p>If successful, you will see the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">Login successful.

You don't have any projects. You can try to create a new project, by running

    oc new-project &lt;projectname&gt;

Welcome! See 'oc help' to get started.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The OpenShift CLI has been successfully configured and ready for use in the lab!</p>
</div>
</div>
<div class="sect2">
<h3 id="_openshift_web_console">OpenShift Web Console</h3>
<div class="paragraph">
<p>OpenShift features a rich user interface for managing resources on the platform.</p>
</div>
<div class="paragraph">
<p>Open a web browser and navigate to the following location</p>
</div>
<div class="paragraph">
<p><a href="https://infranode-&lt;GUID&gt;.generic.opentlc.com:8443">https://infranode-&lt;GUID&gt;.generic.opentlc.com:8443</a></p>
</div>
<div class="paragraph">
<p>Similar to the CLI, a warning will appear stating that insecure certificates are being utilized. Ignore the certificate warning and continue on to the login page.</p>
</div>
<div class="paragraph">
<p>Once again, use the following credentials at the login page</p>
</div>
<div class="paragraph">
<p>User: <strong>admin</strong><br>
Password: <strong>r3dh4t1!</strong></p>
</div>
<div class="paragraph">
<p>The OpenShift catalog should be shown upon successful authentication</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocp-catalog.png" alt="Request GUID">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_resources">Lab Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The primary source of content for this lab is the IoT Serverless project repository.</p>
</div>
<div class="paragraph">
<p><strong>Project location:</strong> <a href="https://github.com/sabre1041/iot-serverless">https://github.com/sabre1041/iot-serverless</a></p>
</div>
<div class="paragraph">
<p>Navigate to the <code>/home/lab-user</code> folder and clone the lab repository. Once cloned navigate into the <code>iot-serverless</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ cd /home/lab-user
$ git clone https://github.com/sabre1041/iot-serverless
Cloning into 'iot-serverless'...
remote: Counting objects: 597, done.
remote: Compressing objects: 100% (86/86), done.
remote: Total 597 (delta 32), reused 126 (delta 27), pack-reused 457
Receiving objects: 100% (597/597), 8.95 MiB | 3.74 MiB/s, done.
Resolving deltas: 100% (162/162), done.

$ cd iot-serverless</code></pre>
</div>
</div>
<div class="paragraph">
<p>The repository contains the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Functions</strong> (<code>iot-serverless-openwhisk-functions</code>): OpenWhisk actions to support values transmitted by IoT assets</p>
</li>
<li>
<p><strong>Applier</strong> (<code>applier</code>): Declarative set of OpenShift resources. Components organized for automated application using the <a href="https://github.com/redhat-cop/openshift-applier">openshift-applier</a> framework.</p>
</li>
<li>
<p><strong>Software Sensor</strong> (<code>iot-serverless-software-sensor</code>): Simulated software sensor representing IoT assets</p>
</li>
<li>
<p><strong>Feeds</strong> (<code>iot-serverless-mqtt-feed</code>): OpenWhisk feed action and provider</p>
</li>
<li>
<p><strong>Data Visualization</strong> (<code>iot-serverless-ui</code>): UI application to display values transmitted by IoT assets</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_deploy_openwhisk" class="sect0">Deploy OpenWhisk</h1>
<div class="paragraph">
<p>OpenWhisk can be deployed using the template provided by OpenWhisk on OpenShift project.
Each component of OpenWhisk will be running in its own container.</p>
</div>
<div class="paragraph">
<p>Create a new project in OpenShift called <em>openwhisk</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc new-project openwhisk --display-name="OpenWhisk"
Now using project "openwhisk" on server "https://infranode-&lt;GUID&gt;.generic.opentlc.com:8443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app centos/ruby-22-centos7~https://github.com/openshift/ruby-ex.git

to build a new example application in Ruby.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy OpenWhisk by instantiating the template</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc process -f https://raw.githubusercontent.com/projectodd/openwhisk-openshift/master/persistent-template.yml | oc create -f -</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A large number of resources will be created. It will take a few minutes to each of the resources to fully deploy to the OpenWhisk project.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use watch command to monitor the progress:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ watch oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all pods are in the “Running” or “Completed state”, hit CTRL+C to break the “watch” command.<br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Pods may initially report in Error status. This condition should resolve itself in a few moments.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Check the status of deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc get pods

NAME                                          READY     STATUS      RESTARTS   AGE
alarmprovider-76d5655b8-vpp7s                 1/1       Running     0          1d
controller-0                                  1/1       Running     2          1d
couchdb-0                                     1/1       Running     0          1d
install-catalog-hx8pc                         0/1       Completed   0          1d
invoker-0                                     1/1       Running     0          1d
nginx-c6f755db5-q627l                         1/1       Running     0          1d
preload-openwhisk-runtimes-kfxcj              0/1       Completed   0          1d
prune-activations-1525060800-n4drp            0/1       Completed   0          19h
refresh-activations-1525132200-lt4h2          0/1       Completed   0          1m
strimzi-cluster-controller-69dccbcc97-724ht   1/1       Running     0          1d
strimzi-openwhisk-kafka-0                     1/1       Running     0          1d
strimzi-openwhisk-zookeeper-0                 1/1       Running     0          1d
wskinvoker-00-5-prewarm-nodejs6               1/1       Running     0          18h
wskinvoker-00-6-prewarm-nodejs6               1/1       Running     0          18h</code></pre>
</div>
</div>
<div class="paragraph">
<p>The system is ready when the controller recognizes the invoker as healthy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc logs -f controller-0 | grep "invoker status changed"

[INFO] [#sid_121] [InvokerPool] invoker status changed to 0 -&gt; UnHealthy
[INFO] [#sid_121] [InvokerPool] invoker status changed to 0 -&gt; Healthy</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenWhisk has been successfully deployed when <code>0 &#8594; Healthy</code> appears in the log above</p>
</div>
<div class="sect2">
<h3 id="_verify_openwhisk_deployment_using_openshift_web_console">Verify OpenWhisk Deployment using OpenShift web console</h3>
<div class="paragraph">
<p>Navigate to the following url in the browser:</p>
</div>
<div class="paragraph">
<p><a href="https://infranode-&lt;GUID&gt;.generic.opentlc.com:8443">https://infranode-&lt;GUID&gt;.generic.opentlc.com:8443</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
OpenShift web UI access url is provided in the screen splash when you ssh into the system
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on the project name (OpenWhisk) in the upper right corner. A successful deployment will look like the following:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/openwhisk-deployment-ui.png" alt="openwhisk deployment ui">
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_the_openwhisk_cli">Configure the OpenWhisk CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>wsk</code> is the CLI to interact with OpenWhisk services which has already been downloaded on this system.  The <code>wsk</code> CLI needs to be to be configured to be able to interact with OpenWhisk deployment.</p>
</div>
<div class="paragraph">
<p>Use the following commands to configure wsk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ AUTH_SECRET=$(oc get secret whisk.auth -o yaml | grep "system:" | awk '{print $2}' | base64 --decode)
$ wsk property set --auth $AUTH_SECRET --apihost $(oc get route/openwhisk --template="{{.spec.host}}")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Successful configuration of wsk will show following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk property set --auth $AUTH_SECRET --apihost $(oc get route/openwhisk --template="{{.spec.host}}")
ok: whisk auth set. Run 'wsk property get --auth' to see the new value.
ok: whisk API host set to openwhisk-openwhisk.apps-&lt;GUID&gt;.generic.opentlc.com</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Use the -i option with wsk to avoid the validation error triggered by the self-signed cert in the nginx service.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_validate_openwhisk_cli_configuration">Validate OpenWhisk CLI configuration</h3>
<div class="paragraph">
<p>Use the following command validate the <code>wsk</code> CLI is operational:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i list</code></pre>
</div>
</div>
<div class="paragraph">
<p>A list of entities in the <em>default</em> namespace will be displayed.</p>
</div>
</div>
</div>
</div>
<h1 id="_preparing_the_lab_environment" class="sect0">Preparing the Lab Environment</h1>
<div class="paragraph">
<p>Now that the OpenShift and OpenWhisk tooling have been set up, let’s start to build the solution!</p>
</div>
<div class="paragraph">
<p>First, create a new project in OpenShift that will be the workspace for the resources being deployed in this lab.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc new-project iot-serverless --display-name="IoT Serverless" --description="Serverless technologies to manage and process Internet of Things (IoT) assets"

Now using project "iot-serverless" on server "https://infranode-&lt;GUID&gt;.generic.opentlc.com:8443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app centos/ruby-22-centos7~https://github.com/openshift/ruby-ex.git</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_and_populating_mongodb">Deploying and Populating MongoDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.mongodb.com/">MongoDB</a> is a popular non relational database (NoSQL). As asset readings are received, their values are stored for for retrieval afterward.</p>
</div>
<div class="paragraph">
<p>OpenShift provides support for MongoDB and includes templates to streamline the deployment.</p>
</div>
<div class="paragraph">
<p>Execute the following command to instantiate the template which will create a new user and set the password to <em>iot-serverless</em> along with a database also called <em>iotserverless</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc process -p MONGODB_USER=iot-serverless -p MONGODB_PASSWORD=iot-serverless MONGODB_DATABASE=iotserverless openshift//mongodb-persistent | oc apply -f-

secret "mongodb" created
service "mongodb" created
persistentvolumeclaim "mongodb" created
deploymentconfig "mongodb" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a few moments, the MongoDB database will be running.<br></p>
</div>
<div class="paragraph">
<p>Confirm that it is running by viewing the list of running pods using the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc get pods

NAME              READY     STATUS    RESTARTS   AGE
mongodb-1-x75j8   1/1       Running   0          3m</code></pre>
</div>
</div>
<div class="paragraph">
<p>A READY column indicating 1/1 denotes the service is ready and available</p>
</div>
<div class="paragraph">
<p>To provide additional information about each of the assets along with supporting later portions of the lab, a MongoDB <a href="https://docs.mongodb.com/manual/core/databases-and-collections/#collections">collection</a> needs to be populated containing these resources. To properly seed the database, an <a href="https://docs.openshift.com/container-platform/latest/dev_guide/jobs.html">OpenShift job</a> can be used. A job is an OpenShift pod that runs to completion, unlike a ReplicationController which will ensure a set number of replicas are constantly running.</p>
</div>
<div class="paragraph">
<p>A template is available to seed the database and contains the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A ConfigMap containing the values to be added to a newly created collection</p>
</li>
<li>
<p>A job that will execute the <a href="mongoinport"><a href="https://docs.mongodb.com/manual/reference/program/mongoimport/" class="bare">https://docs.mongodb.com/manual/reference/program/mongoimport/</a></a> command to import the values contained in the ConfigMap</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the root of the project, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc process -f applier/templates/mongodb-database-seed.yml | oc apply -f-

configmap "mongodb-seed" created
job "mongodb-database-seed-stt8a" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ConfigMap and Job will be created.</p>
</div>
<div class="paragraph">
<p>Use the following command to track the state of the job.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ watch oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the pod with the name beginning with “mongodb-database-seed” has a status of “Completed”, hit CTRL+C to exit the “watch” command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">NAME                                READY     STATUS      RESTARTS   AGE
mongodb-1-x75j8                     1/1       Running     0          2h
mongodb-database-seed-l8lcb-vqc65   0/1       Completed   0          29s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s view the data that was added to the database by accessing a remote shell into the mongodb pod using the <code>oc rsh</code> command.</p>
</div>
<div class="paragraph">
<p>Execute the following command which will obtain the name of the running mongodb pod and start a remote shell session.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc rsh $(oc get pods -l=deploymentconfig=mongodb -o 'jsonpath={.items[0].metadata.name}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DeploymentConfig defining the MongoDB application injects a series of environment variables containing the username, password and name of the primary database.<br></p>
</div>
<div class="paragraph">
<p>Use these environment variables to connect to MongoDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ mongo 127.0.0.1:27017/$MONGODB_DATABASE -u $MONGODB_USER -p $MONGODB_PASSWORD
MongoDB shell version: 3.2.10
connecting to: 127.0.0.1:27017/iotserverless
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
	http://docs.mongodb.org/
Questions? Try the support group
	http://groups.google.com/group/mongodb-user
&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mongoimport command created a new collection called <em>assets</em>.<br></p>
</div>
<div class="paragraph">
<p>Verify the contents of the collection by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">&gt; db.assets.find()

{ "_id" : ObjectId("5aee8bc9e0e39839766c3271"), "name" : "Chemical Pump LX-222", "location" : "Boiler room", "topic" : "/sf/boiler/pump-lx222", "center_latitude" : "37.784202", "center_longitude" : "-122.401858", "geofence_radius" : "3.0", "picture" : "Chemical-Pump.jpg" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3272"), "name" : "Blow down separator valve VL-1", "location" : "Boiler room", "topic" : "/sf/boiler/separator-vl-1", "center_latitude" : "37.784215", "center_longitude" : "-122.401632", "geofence_radius" : "1.0", "picture" : "Blowdown-Valve.jpg" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3273"), "name" : "Surface blow down controller", "location" : "Boiler room", "topic" : "/sf/boiler/controller", "center_latitude" : "37.784237", "center_longitude" : "-122.401410", "geofence_radius" : "1.0", "picture" : "Blowdown-Controller.jpg" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3274"), "name" : "Condensate duplex pump", "location" : "Boiler room", "topic" : "/sf/boiler/cond-pump", "center_latitude" : "37.784269", "center_longitude" : "-122.401302", "geofence_radius" : "3.0", "picture" : "Condensate-Pump.jpg" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3275"), "name" : "Robotic arm joint RT-011", "location" : "Assembly section", "topic" : "/sf/assembly/robotic-joint", "center_latitude" : "37.784115", "center_longitude" : "-122.401380", "geofence_radius" : "1.0", "picture" : "Robotic-Arm.jpg" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3276"), "name" : "Teledyne DALSA Camera", "location" : "Assembly section", "topic" : "/sf/assembly/camera", "center_latitude" : "37.784312", "center_longitude" : "-122.401241", "geofence_radius" : "1.0", "picture" : "Teledyne-Dalsa.jpg" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3277"), "name" : "Lighting control unit RT-SD-1000", "location" : "Warehouse", "topic" : "/sf/warehouse/lighting-control", "center_latitude" : "37.784335", "center_longitude" : "-122.401159", "geofence_radius" : "4.0", "picture" : "Lighting-Control.JPG" }
{ "_id" : ObjectId("5aee8bc9e0e39839766c3278"), "name" : "DIN Rail power supply 240-24", "location" : "Warehouse", "topic" : "/sf/warehouse/power-supply", "center_latitude" : "37.784393", "center_longitude" : "-122.401399", "geofence_radius" : "1.0", "picture" : "DIN-Rail.jpg" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If results were returned, Mongodb has been setup and configured successfully.</p>
</div>
<div class="paragraph">
<p>Type <code>exit</code> to exit out of the mongodb shell.</p>
</div>
<div class="paragraph">
<p>Type <code>exit</code> again to return out of the pod shell.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_openwhisk_entities">Creating OpenWhisk Entities</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_actions">Actions</h3>
<div class="paragraph">
<p><a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/actions.md">Actions</a> are functions that encapsulate code to be run on the OpenWhisk platform. An action can be written as a JavaScript, Swift, Python or PHP function, a Java method, any binary-compatible executable including Go programs and custom executables packaged as Docker containers.</p>
</div>
<div class="paragraph">
<p>Actions can be explicitly invoked, or run in response to an event. Each run of an action results in an activation record that is identified by a unique activation ID. The input to an action and the result of an action are a dictionary of key-value pairs, where the key is a string and the value a valid JSON value. Actions can also be composed of calls to other actions or a defined sequence of actions.
Developing A Simple JavaScript Action</p>
</div>
<div class="paragraph">
<p>To hold the custom assets that we will create during this lab, create a folder called <code>workspace</code> within the project folder and change into this directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ mkdir -p /home/lab-user/iot-serverless/workspace
$ cd /home/lab-user/iot-serverless/workspace</code></pre>
</div>
</div>
<div class="paragraph">
<p>First, a simple JavaScript function will be used to illustrate how to create an invoke actions. When invoked, the action will return a “Hello World” style response.</p>
</div>
<div class="paragraph">
<p>Create a file called <code>hello_openwhisk.js</code> in the workspace folder with the following content.</p>
</div>
<div class="listingblock">
<div class="title">hello_openwhisk.js</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function main() {
    return {payload: "Welcome to IoT Serverless Lab!"};
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the content of the function created, use the wsk tool to create an action called <em>hello_openwhisk</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action update hello_openwhisk hello_openwhisk.js

ok: updated action hello_openwhisk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: The update subcommand of action performs an upsert. If an action does not exist, one will be created. If an action does exist, it will be updated.</p>
</div>
<div class="paragraph">
<p>Finally, invoke the action using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action invoke hello_openwhisk --result

{
    "payload": "Welcome to IoT Serverless Lab!"
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using the <code>--result</code> flag will cause the command to wait until the function completes and print the result
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_working_with_action_parameters">Working With Action Parameters</h4>
<div class="paragraph">
<p>Actions can also accept input parameters that can be used to drive the execution. To illustrate this use case, create a new file called <code>topicReplace.js</code> that will contain an action that will replace any periods in a parameter called topic with forward slashes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-JavaScript" data-lang="JavaScript">function main(params) {

    // Format the Topic to replace . with /
    if(params.topic) {
      params.topic = params.topic.replace(/[.]/g,'/');
    }

    return params;
  }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice how the main method now contains a function parameter which will include any input parameters to the function.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, create an action called <em>topicReplace</em> using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action update topicReplace topicReplace.js

ok: updated action topicReplace</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters can be passed to actions using the <code>--param</code> flag. Verify the action executes correctly by providing a parameter called topic with the content containing periods. The response returned should replace periods with slashes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action invoke topicReplace --result --param topic "1.2 of 8 is 4"

{
    "topic": "1/2 of 8 is 4"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Feel free to try different permutations of the parameters and their values. Note the parameters is only modified if the topic parameter is used and contains a period.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_organizing_resources_as_packages">Organizing Resources as Packages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Multiple related actions can be organized together into <a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/packages.md">packages</a>. Packages allow for common sets of resources, such as parameters, to be applied to multiple actions. A package can be used to centralize many of the components that will be used throughout the rest of the lab.</p>
</div>
<div class="paragraph">
<p>Create a package called <em>iot-serverless</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i package create --shared yes iot-serverless

ok: created package iot-serverless</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The shared flag allows the package to be visible globally
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the <code>package list</code> command to view the newly created package as well as the other packages included by default with the platform</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i package list</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_adding_an_action_to_the_package">Adding an Action to the Package</h3>
<div class="paragraph">
<p>Previously, we created a few actions. One of which was called <em>topicReplace</em>. By default, actions are created in the default whisk.system package. The action was fairly simple and replaced the values of the topic parameter containing periods to slashes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Since a new package <em>iot-serverless</em> was created, delete the existing <em>topicReplace</em> action so that we can organize resources more effectively</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action delete topicReplace

ok: deleted action topicReplace</code></pre>
</div>
</div>
<div class="paragraph">
<p>Aside from the topic name, another key component of input that we are concerned about is the the current location of an asset. The IoT data in this lab provides the latitude and longitude as a single value called data separated by a space. To format both, the topic name as demonstrated earlier, and latitude and longitude values, a JavaScript function is available in a file called <code>iot-serverless-openwhisk-functions/format/formatInput.js</code></p>
</div>
<div class="paragraph">
<p>From the root of the project, create an improved action using the aforementioned JavaScript file using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ cd /home/lab-user/iot-serverless
$ wsk -i action update iot-serverless/formatInput iot-serverless-openwhisk-functions/format/formatInput.js

ok: updated action iot-serverless/formatInput</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, display the contents of the package which will show the action which was just created</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i package get iot-serverless --summary

package /whisk.system/iot-serverless
   (parameters: none defined)
 action /whisk.system/iot-serverless/formatInput
   (parameters: none defined)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_to_triggers">Introduction to Triggers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Thus far, we have explicitly invoked actions containing our business logic. In a microservices world, architectures have adopted the use of eventing or <a href="https://www.reactivemanifesto.org/">reactive</a> patterns to invoke business logic instead of proactive based approaches.</p>
</div>
<div class="paragraph">
<p>In OpenWhisk, to support this architectural approach, <a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/triggers_rules.md">Triggers</a> represent a class of events emitted by event source e.g. location coordinates from factory assets. Triggers can be fired manually or in response to certain events.</p>
</div>
<div class="paragraph">
<p>To demonstrate how triggers can be utilized, let’s go ahead and create a trigger called <em>iotServerlessTrigger</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i trigger create iotServerlessTrigger

ok: created trigger iotServerlessTrigger</code></pre>
</div>
</div>
<div class="paragraph">
<p>Confirm the trigger has been created by listing the defined triggers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i trigger list

triggers
/whisk.system/iotServerlessTrigger                                     private</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_triggers_to_actions_using_rules">Connecting Triggers to Actions Using Rules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While triggers maintain sourcing events within OpenWhisk, they have no effective use until they are connected with an action. This is where <a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/triggers_rules.md">Rules</a> comes into play. Rules associate a single trigger with a single action. When a trigger is fired, a rule will pass the invocation to the action.</p>
</div>
<div class="paragraph">
<p>To demonstrate how Rules are utilized in OpenWhisk, create a new rule that associates the <em>iotServerlessTrigger</em> trigger to the <em>formatInput</em> action within the <em>iot-serverless</em> package called <em>iotServerlessRule</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i rule update iotServerlessRule iotServerlessTrigger iot-serverless/formatInput

ok: updated rule iotServerlessRule</code></pre>
</div>
</div>
<div class="paragraph">
<p>N
ow that the trigger has been connected to action by way of the rule, we can demonstrate how OpenWhisk utilizes this pattern by “firing” the trigger. Recall, the formatInput action requires two parameters be specified: topic and data.</p>
</div>
<div class="paragraph">
<p>Invoke the trigger as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i trigger fire iotServerlessTrigger --param topic /sf/boiler/controller --param data "37.784237 -122.401410"

ok: triggered /_/iotServerlessTrigger with id 2f195129de6e410f995129de6e210f88</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_activation_record">Activation Record</h3>
<div class="paragraph">
<p>When the trigger was invoked, the referenced <em>id</em> refers to an <a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/reference.md">Activation Record</a> which confirms the request was accepted by OpenWhisk. When we invoked the action previously, we also passed in the <code>--result</code> flag which tells OpenWhisk to monitor the action and wait for a response to be produced. Since triggers do not produce a result as it is the Rule that performs the work of invoking the action,  we will have to investigate the activation chain to discover the result of the action.</p>
</div>
<div class="paragraph">
<p>The details of the activation can be found by using the following command replacing the id from the prior command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i activation get &lt;ID&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside the activation response, you will notice in the <em>logs</em> property a JSON payload that illustrates the response that was returned from the invocation of the action. Inside this payload includes the <em>activationId</em> that can be used to obtain the result from the <em>formatInput</em> action as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">...
    "logs": [
        "{\"statusCode\":0,\"success\":true,\"activationId\":\"26fef4e532f34a41bef4e532f39a41b9\",\"rule\":\"whisk.system/iotServerlessRule\",\"action\":\"whisk.system/iot-serverless/formatInput\"}"
    ],
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, query the activation, but this time using the activationId that is present in the logs field from the prior invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i activation get &lt;ID&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Inside the response field will be the result of the formatInput action similar to the following</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">    "response": {
        "status": "success",
        "statusCode": 0,
        "success": true,
        "result": {
            "data": "37.784237 -122.401410",
            "latitude": "37.784237",
            "longitude": "-122.401410",
            "topic": "/sf/boiler/controller"
        }
    },</code></pre>
</div>
</div>
<div class="paragraph">
<p>As displayed, the parameters that were provided to the trigger were sent to the <em>formatInput</em> action by way of the rule that we defined and the latitude and longitude fields were split out as expected based on the values provided in the data field.</p>
</div>
</div>
<div class="sect2">
<h3 id="_developing_a_node_js_action_to_enrich_input">Developing a Node.js Action to Enrich Input</h3>
<div class="paragraph">
<p>In a prior lab, we introduced how to create simple OpenWhisk actions using JavaScript. While standalone JavaScript actions are very lightweight, they do have limitations in the functionality that they are able to provide, especially when additional libraries or dependencies are required. A popular pattern for transmitting data is to pass along a key and perform a lookup in a database to enrich content. In this section, you will configure a Node.js based action to lookup content in the the MongoDB database that was previously seeded with values based on an input parameter. The values contained within the document will be appended to the input parameters and returned as output.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, from the root of the project folder, navigate to the folder containing the source for the Node.js based function:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ cd iot-serverless-openwhisk-functions/enricher</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within this folder, you will notice three files:</p>
</div>
<div class="paragraph">
<p>package.json - npm manifest file
enricher.js - OpenWhisk function
example.env - Sample file that will be used as a base for providing environment variables for the function</p>
</div>
<div class="paragraph">
<p>Take a moment to explore each of these files and their contents
One of the principles of reusable software is to externalize configurations outside of the source code. To connect to MongoDB from the function, the properties related to the location of the database and credentials must be provided. Node.js offers the functionality to externalize these values in a file called .env alongside the application. At runtime, the values provided will be available as environment variables for the application to leverage. An file called example.env has been provided with the keys that require configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the file to contain the following values based on the configuration of MongoDB</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">MONGODB_HOST=mongodb.iot-serverless.svc
MONGODB_USER=iot-serverless
MONGODB_PASSWORD=iot-serverless
MONGODB_DATABASE=iotserverless</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Rename the file to .env so that the values will be available to the function</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ mv example.env .env</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Install all of the dependencies that are defined in the package.json file</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ npm install</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now, package up the Node.js application</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ npm run package</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new file called enricher.zip will be created in the dist folder. This will be uploaded to OpenWhisk as the content used by the function.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new function called enricher by executing the following command</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ npm run deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Internally, npm runs the command wsk -i action update iot-serverless/enricher dist/enricher.zip --kind nodejs:8. The npm run deploy is a convenience method to simplifying the creation of the function.</p>
</div>
<div class="paragraph">
<p>With the function deployed, let’s test it out.</p>
</div>
<div class="paragraph">
<p>The MongoDB has a collection called assets which was populated with data earlier. Inside this collection, a column called topic specifies the name of the topic associated with the particular asset (more on that later). The enricher function will accept a parameter called topic and perform a lookup on the collection for any document matching the value and return the contents of the document.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Once again, view the contents of the assets table by executing the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc rsh $(oc get pods -l=deploymentconfig=mongodb -o 'jsonpath={.items[0].metadata.name}') bash -c "mongo 127.0.0.1:27017/\${MONGODB_DATABASE} -u \${MONGODB_USER} -p \${MONGODB_PASSWORD} --eval='db.assets.find()'"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Select one of the topic values returned and invoke the enricher function (for example, ‘/sf/boiler/pump-lx222’ topic name)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action invoke iot-serverless/enricher --param topic “/sf/boiler/pump-lx222” --result</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the content of the document has been returned. Feel free to use another topic name from the database results as well as a value that is not present in the database. Only the input value will be returned.
Creating a Sequence of Actions</p>
</div>
<div class="paragraph">
<p>Thus far, we have created two functions, one that will perform input formatting, and another that will execute a lookup from the database based on provided values. Whether you have noticed or not, several of the parameter names have been identical (such as topic). This is no coincidence. OpenWhisk provides the capability chaining multiple actions together where the output from one action is the input for another action. This functionality is known as a Sequence. Sequences are entirely separate actions and define the order in which actions are executed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new sequence action called IotServerlessSequence in the iot-serverless package that will first call formatInput action and then use the output as the input parameters for the enricher action.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action update iot-serverless/iotServerlessSequence --sequence iot-serverless/formatInput,iot-serverless/enricher</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>With a new method for initiating the action to format the input, update the iotServerlessRule to invoke the iotServerlessSequence sequence action instead of directly calling the formatInput action:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i rule update iotServerlessRule iotServerlessTrigger iot-serverless/iotServerlessSequence</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Fire the trigger using the same parameters as before</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i trigger fire iotServerlessTrigger --param topic /sf/boiler/controller --param data "37.784237 -122.401410"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Once again the id of the activation of the trigger will be returned. Using the steps from the Activations section, locate the activationId within the trigger activation to determine the output from the execution of the sequence action. A value similar to the following indicates the sequence action processed successfully.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-Ruby" data-lang="Ruby">    "response": {
        "status": "success",
        "statusCode": 0,
        "success": true,
        "result": {
            "center_latitude": "37.784237",
            "center_longitude": "-122.401410",
            "data": "37.784237 -122.401410",
            "geofence_radius": "1.0",
            "latitude": "37.784237",
            "location": "Boiler room",
            "longitude": "-122.401410",
            "name": "Surface blow down controller",
            "picture": "Blowdown-Controller.jpg",
            "topic": "/sf/boiler/controller"
        }
    },
    "logs": [
        "05233e250a0d4276a33e250a0db27622",
        "85f6c5a268cf45dcb6c5a268cf35dc2c"
    ],</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how latitude and longitude have been split out into separate fields as per the logic of the formatInput action along with values returned from MongoDB as provided by theIenricher action.
In addition, there is a field called logs containing two values. Those are the activation ID’s from the execution of each function in the sequence action. Feel free to view the execution of those actions as well.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_geofence_for_asset_tracking">Using Geofence for asset tracking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Geofence is a virtual perimeter for a geographic area.  A geofence can be set dynamically e.g. circle  around a center point or defined as a boundary around an area. Geofencing can be used for several IoT use cases including asset tracking, security &amp; surveillance, retail etc. In the use case for this lab, factory equipments are geofenced by their assigned location
Haversine formula</p>
</div>
<div class="paragraph">
<p>To determine whether something is within its geofence, haversine formula is used. The haversine formula determines the great-circle distance between two points on a sphere given their longitudes and latitudes.</p>
</div>
<div class="paragraph">
<p>For any two points on a sphere, the haversine of the central angle between them is given by:</p>
</div>
<div class="paragraph">
<p>Haversine
formula:
a = sin²(Δφ/2) + cos φ1 ⋅ cos φ2 ⋅ sin²(Δλ/2)
c = 2 ⋅ atan2( √a, √(1−a) )
d = R ⋅ c
where
φ is latitude, λ is longitude, R is earth’s radius (6,371km)
All angles need to be in radians to pass to trig functions</p>
</div>
<div class="paragraph">
<p>Source: <a href="https://www.movable-type.co.uk/scripts/latlong.html" class="bare">https://www.movable-type.co.uk/scripts/latlong.html</a></p>
</div>
<div class="paragraph">
<p>The value needs to be converted from degrees to radians using the formula:
Radians = degrees * (pi/180)</p>
</div>
<div class="paragraph">
<p>The JavaScript function implementing haversine formula is already provided for this lab. This function called geofence.js is located at iot-serverless-openwhisk-functions/geofence/. Take a moment and familiarize yourself with the source code. It is important that no modifications to the file be made as it may impact the expected outcome of the lab.</p>
</div>
<div class="sect3">
<h4 id="_create_geofence_action">Create geofence Action</h4>
<div class="ulist">
<ul>
<li>
<p>Using the provided function, use the wsk tool to create an action called geofence:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action update iot-serverless/geofence iot-serverless-openwhisk-functions/geofence/geofence.js</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Confirm the action has been created by describing the contents of the iot-serverless package.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i package get iot-serverless --summary</code></pre>
</div>
</div>
<div class="paragraph">
<p>There should now be three functions within this package: formatInput, enricher, and geofence
Finally, since a new action was created, we will need to update the existing sequence action so that the geofence action is executed after the data enrichment action.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Update the sequence action by executing the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action update iot-serverless/iotServerlessSequence --sequence iot-serverless/formatInput,iot-serverless/enricher,iot-serverless/geofence</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_putting_sequence_to_use">Putting Sequence to use</h5>
<div class="paragraph">
<p>Lets see how to use this in a real life scenario of a factory that wants to monitor an asset called DIN Rail power supply. This asset is expected to be located at (37.784393, -122.401399) and can move only within an assigned area (3m) i.e spare inventory section in the warehouse. If this asset moves outside this assigned area (geofence) then an alert will be triggered. Let’s say the asset now reports its current location as (37.784420, -122.401399) which is outside its geofence then the action sequence should set a value of “alert: 1“ in the payload.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Test this scenario with the sequence we created above:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action invoke iot-serverless/iotServerlessSequence --param topic /sf/warehouse/power-supply --param data "37.784420 -122.401399"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Should result in:
on processed successfully.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-Ruby" data-lang="Ruby">    "response": {
        "status": "success",
        "statusCode": 0,
        "success": true,
        “alert”: 1,
        "result": {
            "center_latitude": "37.784393",
            "center_longitude": "-122.401399",
            "data": "37.784393 -122.401399",
            "geofence_radius": "3.0",
            "latitude": "37.784420",
            "location": "Warehouse",
            "longitude": "-122.401399",
            "name": "DIN Rail power supply 240-24",
            "picture": "DIN-Rail.jpg",
            "topic": "/sf/warehouse/power-supply"
        }
    },
    "logs": [
        "05233e250a0d4276a33e250a0db27622",
        "85f6c5a268cf45dcb6c5a268cf35dc2c",
        "96233e250a0d4276a33e250a0db28512"
    ],</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inserting_records_into_the_database">Inserting Records into the database</h3>
<div class="paragraph">
<p>The final step in the data flow after all of the prior actions have executed is that the records need to be persisted so that it may be retrieved at a later point in time. Records will be inserted into the MongoDB database through the use of an action called dbInsert. Since the connectivity requires database drivers and additional dependencies, a Node.js based function will be used once again.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, from the root of the project folder, navigate to the folder containing the source for the dbInsert action:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ cd iot-serverless-openwhisk-functions/dbinsert</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Install all of the dependencies that are defined in the package.json file.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ npm install</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To connect to MongoDB from the function, the properties related to the location of the database and credentials must be provided. Since connectivity will be made from the action to the same mongodb instance as the enricher function created earlier, the .env external environmental variable file used for that function can be reused and copied into the current directory:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ cp ../enricher/.env .</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now, package up the Node.js application:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ npm run package</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new action called iot-serverless/dbInsert by executing the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ npm run deploy</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Confirm the the action called iot-serverless/dbInsert has been created within the iot-serverless package:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i package get iot-serverless --summary</code></pre>
</div>
</div>
<div class="paragraph">
<p>There should now be 5 actions displayed (4 normal actions and 1 sequence action)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Update the sequence action to include all of the previously created actions:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i action update iot-serverless/iotServerlessSequence --sequence iot-serverless/formatInput,iot-serverless/enricher,iot-serverless/geofence,iot-serverless/dbInsert</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validate_entire_sequence_of_action">Validate Entire Sequence of Action</h3>
<div class="paragraph">
<p>Now that we have created the entire series of OpenWhisk actions tied together by a sequence action to process the data which will be transmitted from IoT data, lets validate the entire flow which will result in a document entered into the MongoDb database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Yet again, fire the iotServerlessTrigger trigger using the same set of arguments that have been utilized previously:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ wsk -i trigger fire iotServerlessTrigger --param topic /sf/boiler/controller --param data "37.784237 -122.401410"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Determine the results of the activations from both the trigger and rule. A result similar to the following indicates the record was successfully saved to MongoDB.
* Obtain a shell session in the MongoDB pod by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc rsh $(oc get pods -l=deploymentconfig=mongodb -o 'jsonpath={.items[0].metadata.name}') bash -c "mongo 127.0.0.1:27017/\${MONGODB_DATABASE} -u \${MONGODB_USER} -p \${MONGODB_PASSWORD}"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The dbInsert action persists data into a collection called results. Query the values of the collection by executing the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">&gt; db.results.find()</code></pre>
</div>
</div>
<div class="paragraph">
<p>A single value should be returned similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">{ "_id" : ObjectId("5aed26bbd9ca04f727a34329"), "name" : "Surface blow down controller", "location" : "Boiler room", "latitude" : "37.784237", "alert" : 0, "data" : "37.784237 -122.401410", "geofence_radius" : "1.0", "longitude" : "-122.401410", "picture" : "Blowdown-Controller.jpg", "topic" : "/sf/boiler/controller", "center_longitude" : "-122.401410", "center_latitude" : "37.784237", "date" : ISODate("2018-05-05T03:36:27.628Z") }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally, remove the test data by dropping the contents of the results collection and exit out of the MongoDB shell and pod</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">&gt; db.results.drop()</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point the OpenWhisk actions have been successfully been validated</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_iot_components">Deploying IoT Components</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_iot_data_transports">IoT Data Transports</h3>
<div class="paragraph">
<p>Due to its unique requirements (less compute capable devices, low power use, small message payload and large number of devices), IoT requires different data transport protocols than other use cases e.g. mobile, client/server or embedded. Some of the commonly used data transport protocols for IoT include MQTT, CoAP, LWM2M and AMQP. For this lab, MQTT is being used as the data transport for assets sending location data to message broker.</p>
</div>
<div class="sect3">
<h4 id="_deploying_amq">Deploying AMQ</h4>
<div class="paragraph">
<p>Red Hat JBoss AMQ provides fast, lightweight, and secure messaging  and supports AMQP, MQTT, STOMP, and WebSocket protocols. For this lab, a containerized xPaaS image of AMQ, designed for use with OpenShift, is being used. A series of templates are also available to streamline the deployment of AMQ onto OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy the AMQ image to OpenShift by by executing the following command which will instantiate the template provided by the platform:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc process -p MQ_USERNAME=iot-serverless -p MQ_PASSWORD=iot-serverless -p MQ_PROTOCOL=openwire,mqtt -p AMQ_MESH_DISCOVERY_TYPE=dns openshift//amq63-persistent | oc apply -f-</code></pre>
</div>
</div>
<div class="paragraph">
<p>The AMQ broker will be created to support accepting MQTT messages from the IoT device along with the default Openwire protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A DeploymentConfig called broker-amq was created to manage the deployment of the Broker. To illustrate the configuration of the AMQ broker, describe the contents of the broker-amq DeploymentConfig:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc describe dc broker-amq</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Key items to note within the podTemplate is a container called broker-amq and the exposure of port 1883, which is the default port for the MQTT protocol along with an environment variable called AMQ_TRANSPORTS which enables both the OpenWire and MQTT protocols on the broker.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Confirm the broker is running by verifying the pod is up and running using the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc get pods -l application=broker</code></pre>
</div>
</div>
<div class="paragraph">
<p>A READY column indicating 1/1 denotes the service is ready and available</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_into_openwhisk">Connecting into OpenWhisk</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the AMQ broker is up and running within OpenShift and able to accept traffic sent by IoT assets using the MQTT protocol, how these messages are consumed by OpenWhisk so that they can be used by the actions previously becomes the next area of concern.</p>
</div>
<div class="paragraph">
<p>So far, our primary entrypoint for firing actions has been through a Trigger. However, since the MQTT transport is an eventing based protocol where messages are streamed, the use of triggers can be a limiting factor. OpenWhisk provides an alternative option that builds on top of the concept of triggers and supports streaming events onto the platform called Feeds.</p>
</div>
<div class="sect2">
<h3 id="_feeds">Feeds</h3>
<div class="paragraph">
<p>Feeds are an advanced concept in OpenWhisk where users can expose an event producer service within a package. A feed is controlled by a Feed Action which handles deleting, pausing and resuming the streaming of events. Feeds can be implemented in one of three architectural patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hooks</p>
</li>
<li>
<p>Polling</p>
</li>
<li>
<p>Persistent Connections</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In our use case for accepting messages from the AMQ broker, the Persistent Connection feed option is the most applicable.</p>
</div>
<div class="paragraph">
<p>A full overview of feeds and the architecture can be found in the OpenWhisk project documentation.
=== Feed Action</p>
</div>
<div class="paragraph">
<p>To manage the registration of MQTT topics for which messages should be sent into the OpenWhisk platform, a feed action has been provided at in the repository at iot-serverless-mqtt-feed/action/feedAction.js</p>
</div>
<div class="paragraph">
<p>Feel free to browse the content of the action.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the feed action to the iot-serverless package using the following command executed from the root of the repository:</p>
<div class="literalblock">
<div class="content">
<pre>[source,bash]
----
$ wsk -i action update -a feed true iot-serverless/mqttFeed iot-serverless-mqtt-feed/action/feedAction.js</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>TIP: The -a flag is designates that an annotation should be placed on the associated action.</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>An annotation is a piece of metadata that can be applied to an action to provide additional information without disrupting the underlying schema. When creating a feed action, an annotation called feed with a value of true is specified so that the platform will recognize and manage the asset appropriately.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Display the contents of the iot-serverless package to confirm the feed has been registered</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $ wsk -i package get iot-serverless --summary</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_feed_provider">Feed Provider</h3>
<div class="paragraph">
<p>Recall the three types of feeds that can be implemented: hooks, polling and connections. We stated that we would be utilizing the connection type of feed as it will provide a persistent connection to the AMQ broker. Since actions are short lived, another component must be added to the environment to maintain the long lived connection to AMQ. This service is known as a Feed Provider.</p>
</div>
<div class="paragraph">
<p>To conform with the feed architecture within OpenWhisk, the provider will need to expose a REST API that manages the control of the feed as well  as act as a proxy between AMQ and OpenWhisk.</p>
</div>
<div class="paragraph">
<p>A Feed Provider implementation has been provided in the iot-serverless-mqtt-feed/provider/ folder and is a Spring Boot based application.</p>
</div>
<div class="paragraph">
<p>Templates have been created to support the building of a custom image containing the application along with the deployment to OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, instantiate the template to build the image:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $ oc process -f applier/templates/mqtt-provider-build.yml | oc apply -f-</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new BuildConfig and ImageStream will be created along with the triggering of the Source-to-Image based build in OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new build should be automatically triggered. Verify the build has started by running the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $  oc get builds -l application=mqtt-provider</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>When a build is present and running, the logs from the build execution can be seen using the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $ oc logs -f builds/&lt;build_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the image has been built successfully, another template can be instantiated to create the associated DeploymentConfig and Service. A set of parameters must be provided when processing the template including the credentials for access the MQTT broker and the location of the broker within the iot-serverless project.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute the following command to instantiate the software sensor deployment template.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $ oc -p MQ_USERNAME=iot-serverless -p MQ_PASSWORD=iot-serverless -p MQ_APPLICATION_SERVICE=broker-amq-tcp process -p MONGODB_SERVICE=mongodb -f applier/templates/mqtt-provider-deployment.yml | oc apply -f-</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the mqtt-provider is active by executing the command oc get pods. If the pod with the prefix mqtt-provider displays 1/1 in the READY column, the pod is successfully running.</p>
</div>
<div class="paragraph">
<p>Finally, with the Feed action and provider deployed, the final step is to update the existing iotServerlessTrigger to make use of the feed action. The feed action takes in one parameter called “topic” which is the selector pattern that the provider should consider when registering itself with the broker. Triggers utilizing feeds also need to have the --feed flag also specified. Unfortunately, this flag is only available when creating new triggers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete the existing iotServerlessTrigger trigger:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $ wsk -i trigger delete iotServerlessTrigger</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now recreate the trigger to also denote the feed that should be used as the event source and the parameter with the topic pattern:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> $ wsk -i trigger create iotServerlessTrigger --feed iot-serverless/mqttFeed -p topic “.sf.&gt;”</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no error was returned, the trigger was successfully registered with the provider. This can be confirmed by viewing the logs for the mqtt-trigger which will display the following:</p>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 2018-05-05 18:22:29.057  INFO 1 --- [nio-8080-exec-7] c.r.i.controller.FeedProviderController  : Trigger Name: /_/iotServerlessTrigger
 2018-05-05 18:22:29.242  INFO 1 --- [nio-8080-exec-7] c.redhat.iot.service.TriggerDataService  : Saving Trigger</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_software_sensor_application">Software Sensor Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the connectivity and integration between the AMQ broker and OpenWhisk now complete, the next step is to integrate IoT data using a simulated software sensor.</p>
</div>
<div class="sect2">
<h3 id="_software_sensor">Software Sensor</h3>
<div class="paragraph">
<p>Software sensor is a Spring Boot based application that simulates GPS sensor data for the assets in the factory. It periodically sends location coordinates for each asset similar to how a real GPS sensor works.</p>
</div>
<div class="paragraph">
<p>Software sensor application is driven by a configuration file called application.yml (located at:  iot-serverless-software-sensor/src/main/resources). The configuration file provides current  location parameters for each asset.</p>
</div>
<div class="sect3">
<h4 id="_deploy_the_software_sensor">Deploy the Software Sensor</h4>
<div class="paragraph">
<p>Templates have been created to support the building of a custom image containing the application along with the deployment to OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, instantiate the template to build the image:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ oc process -f applier/templates/software-sensor-build.yml | oc apply -f-</pre>
</div>
</div>
<div class="paragraph">
<p>A new BuildConfig and ImageStream will be created along with the triggering of the Source-to-Image based build in OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new build should be automatically triggered. Verify the build has started by running the following command:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ oc get builds</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>When a build is present and running, the logs from the build execution can be seen using the following command:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ oc logs -f builds/&lt;build_name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>When the image has been built successfully, another template can be instantiated to create the associated DeploymentConfig and Service. A set of parameters must be provided when processing the template including the credentials for access the MQTT broker and the location of the broker within the iot-serverless project.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute the following command to instantiate the software sensor deployment template.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ oc -p MQTT_USERNAME=iot-serverless -p MQTT_PASSWORD=iot-serverless -p MQTT_APPLICATION_SERVICE=broker-amq-mqtt -p MQTT_TOPIC=proxsensor01 process -f applier/templates/software-sensor-deployment.yml | oc apply -f-</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scale_up_software_sensor">Scale up software sensor</h4>
<div class="ulist">
<ul>
<li>
<p>By default, the software sensor is configured with a replica count of 0 Execute the following command to enable software sensor by changing to one replica:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ oc scale dc/software-sensor --replicas=1</pre>
</div>
</div>
<div class="paragraph">
<p>Verify the software sensor is active by executing the command oc get pods. If the pod with the prefix software-sensor displays 1/1 in the READY column, the pod is successfully running.</p>
</div>
<div class="paragraph">
<p>This application makes use of OpenShift Health Check to verify the connectivity of the MongoDB database. Before marking the pod active and healthy, HTTP requests are made on an endpoint exposed on the application supported by Spring Boot Endpoints. The source code for this health check can be found at iot-serverless-software-sensor/src/main/java/com/redhat/iot/MqttHealthIndicator.java</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With the application running, access the software-sensor logs to confirm that it is transmitting data:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ oc logs $(oc get pods -l=application=software-sensor -o 'jsonpath={.items[0].metadata.name}')</pre>
</div>
</div>
<div class="paragraph">
<p>If no errors are observed and messages similar to the following are displayed, the deployment was successful.</p>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ 2018-05-04 05:26:27.352  INFO 1 --- [    scheduler-3] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Chemical Pump LX-222 - Iteration: 2 - Latitude: 37.784218 - Longitude: -122.401858
 2018-05-04 05:26:27.353  INFO 1 --- [    scheduler-4] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Condensate duplex pump - Iteration: 2 - Latitude: 37.784269 - Longitude: -122.401312
 2018-05-04 05:26:27.362  INFO 1 --- [    scheduler-5] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Lighting control unit RT-SD-1000 - Iteration: 2 - Latitude: 37.7843430 - Longitude: -122.401159
 2018-05-04 05:26:32.352  INFO 1 --- [    scheduler-9] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Chemical Pump LX-222 - Iteration: 3 - Latitude: 37.784234 - Longitude: -122.401858
 2018-05-04 05:26:32.353  INFO 1 --- [    scheduler-1] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Condensate duplex pump - Iteration: 3 - Latitude: 37.784269 - Longitude: -122.401322
 2018-05-04 05:26:32.364  INFO 1 --- [   scheduler-10] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Lighting control unit RT-SD-1000 - Iteration: 3 - Latitude: 37.7843510 - Longitude: -122.401159
 2018-05-04 05:26:34.351  INFO 1 --- [    scheduler-7] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Robotic arm joint RT-011 - Iteration: 1 - Latitude: 37.784115 - Longitude: -122.40138
 2018-05-04 05:26:35.351  INFO 1 --- [   scheduler-11] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Teledyne DALSA Camera - Iteration: 1 - Latitude: 37.784312 - Longitude: -122.401241
 2018-05-04 05:26:37.352  INFO 1 --- [    scheduler-8] com.redhat.iot.AssetRunner               : Running Scheduled Task for Asset: Chemical Pump LX-222 - Iteration: 4 - Latitude: 37.784250 - Longitude: -122.401858</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_visualizing_data">Visualizing Data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_tracing_entire_data_flow">Tracing entire data flow</h3>
<div class="paragraph">
<p>This lab will go over results of functions created in the previous labs, validating messages from devices to broker and viewing location of various assets on a map.</p>
</div>
</div>
<div class="sect2">
<h3 id="_view_messages_in_amq_console">View messages in AMQ Console</h3>
<div class="ulist">
<ul>
<li>
<p>Click on the AMQ pod to access the deployment:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image1.png" alt="AMQ Pod">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on Open Java Console to access AMQ console:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image??.png" alt="Getting to AMQ Console">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on Topic to see the expanded view:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image??.png" alt="AMQ Topic">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on any topic name (unique for each asset) to see number of dequeued messages:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image??.png" alt="Message Queue">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_view_data_in_ui_application">View data in UI Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To visualize the data that has been sent by the software simulator and processed through the set of OpenWhisk functions, a Patternfly based UI app will be deployed that will show the results on a geographical map. The app will show the geofence of each asset and description of the selected asset. If an asset crosses its geofence, then an alert will be shown on the map. The google map API is being used to display the location of assets and geofence on the map. Source for the UI application is located  (iot-serverless-ui/src/main/resources/static).</p>
</div>
<div class="sect2">
<h3 id="_deploy_the_ui_application">Deploy the UI Application</h3>
<div class="paragraph">
<p>Templates have been created to support the building of a custom image containing the application along with the deployment to OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, instantiate the template to build the image:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc process -f applier/templates/ui-build.yml | oc apply -f-</pre>
</div>
</div>
<div class="paragraph">
<p>A new BuildConfig and ImageStream will be created along with the triggering of the Source-to-Image based build in OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new build should be automatically triggered. Verify the build has started by running the following command:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get builds -l application=ui</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>When a build is present and running, the logs from the build execution can be seen using the following command:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc logs -f builds/&lt;build_name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>When the image has been built successfully, another template can be instantiated to create the associated DeploymentConfig, Service and the Route exposing the application outside the cluster. A single parameter must be provided with the name of the MongoDB service which is used to connect to the backend persistent store within the iot-serverless project.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute the following command to instantiate the software sensor deployment template.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc -p MONGODB_SERVICE=mongodb process -f applier/templates/ui-deployment.yml | oc apply -f-</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To access the newly deployed application, execute the following command to get the url of the from the route:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>source,bash]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get routes</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In the browser, navigate to the url listed in the HOST column.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternatively, OpenShift web console can be used to access the UI application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on the UI pod to view the expanded view:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image11.png" alt="UI App Expand">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on the listed route:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image10.png" alt="UI App URL">
</div>
</div>
<div class="paragraph">
<p>UI app is will display the real time location of assets on the map:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image4.png" alt="UI App">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Select an asset by clicking on its marker. Selected asset will display a larger marker (1) and its geofence (2):</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image12.png" alt="Asset Fence In">
</div>
</div>
<div class="paragraph">
<p>If an asset has crossed it geofence (1), a warning marker (2) will be displayed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image9.png" alt="Asset Fence Out">
</div>
</div>
<div class="paragraph">
<p>More information about the selected asset is also displayed at the bottom:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/image8.png" alt="Asset Info">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_labs_optional">Advanced Labs (Optional)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_setting_default_parameters">Setting Default Parameters</h3>
<div class="paragraph">
<p>One of the benefits of packages is the ability to define default parameters that can be automatically applied to actions. In the iot-serverless package that was created in the prior section, the formatInput action takes in two parameters, the name of the topic for which messages will be received from (topic) and a single string consisting of the latitude and longitude. When invoking the action, we could specify the parameters explicitly as done previously, or define them globally within the package.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_next_steps">Conclusion &amp; Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This lab provides hands-on experience with Serverless Architecture, FaaS, Apache OpenWhisk, OpenShift and how IoT use case like Smart Asset Management can use these technologies.
Working through the various exercises in this lab, you learned about how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy Apache OpenWhisk and learning how to interact with it using CLI</p>
</li>
<li>
<p>Deploy MongoDB and seeding it with documents</p>
</li>
<li>
<p>Creating OpenWhisk Actions in JavaScript and Node.js</p>
</li>
<li>
<p>Creating Trigger, Package and Rules</p>
</li>
<li>
<p>Chaining Actions into a Sequence</p>
</li>
<li>
<p>Working with Geofence</p>
</li>
<li>
<p>Deploying IoT Components</p>
</li>
<li>
<p>Working with Feeds and Providers</p>
</li>
<li>
<p>Deploying Software Sensor Application</p>
</li>
<li>
<p>Visualizing data through UI</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_next_steps">Next Steps</h3>
<div class="paragraph">
<p>All the components that were built this lab can be automated using Ansible playbooks. The repo (<a href="https://github.com/sabre1041/iot-serverless" class="bare">https://github.com/sabre1041/iot-serverless</a>) provides instructions on how to deploy this lab with a few easy steps.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-05-07 23:04:44 PDT
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
</body>
</html>